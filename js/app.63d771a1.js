(function(){"use strict";var e={151:function(e,t,i){var a=i(3751),s=i(953),l=(i(4114),i(641));const r={id:"app-layout"},o={class:"sidebar"},n={class:"main-content"};function c(e,t,i,a,s,c){const d=(0,l.g2)("router-view"),u=(0,l.g2)("GlobalAudioPlayer");return(0,l.uX)(),(0,l.CE)("div",r,[(0,l.Lk)("aside",o,[t[2]||(t[2]=(0,l.Lk)("h2",{class:"sidebar-title"},"🎵 功能导航",-1)),(0,l.Lk)("button",{class:"sidebar-btn",onClick:t[0]||(t[0]=t=>e.$router.push("/"))},"音乐搜索"),(0,l.Lk)("button",{class:"sidebar-btn",onClick:t[1]||(t[1]=t=>e.$router.push("/favorite"))},"我喜欢的音乐歌单")]),(0,l.Lk)("main",n,[(0,l.bF)(d)]),s.player?((0,l.uX)(),(0,l.Wv)(u,{key:0,src:s.player.url,title:s.player.song,artist:s.player.singer,cover:s.player.cover,musicId:s.player.id,playMode:s.playMode,onTogglePlayMode:c.togglePlayMode,onEnded:c.playNext,onTimeupdate:c.handleTimeUpdate,onPrev:c.playPrev,onNext:c.playNext},null,8,["src","title","artist","cover","musicId","playMode","onTogglePlayMode","onEnded","onTimeupdate","onPrev","onNext"])):(0,l.Q3)("",!0)])}i(8111),i(2489),i(7642),i(8004),i(3853),i(5876),i(2475),i(5024),i(1698);var d=i(33);const u={class:"global-audio-player"},h={class:"progress-bar"},v={class:"player-content"},y=["src"],p={class:"player-meta"},m={class:"player-title"},f={class:"player-artist"},g={class:"center-controls"},k=["disabled"],L=["disabled"],b={key:0,viewBox:"0 0 24 24",class:"icon"},I={key:1,viewBox:"0 0 24 24",class:"icon"},S=["disabled"],C=["title"],w={key:0,viewBox:"0 0 24 24",class:"icon icon-small"},M={key:1,viewBox:"0 0 24 24",class:"icon icon-small"},P={key:2,viewBox:"0 0 24 24",class:"icon icon-small"},$={class:"volume-control"},T={key:0,viewBox:"0 0 24 24",class:"icon icon-small"},E={key:1,viewBox:"0 0 24 24",class:"icon icon-small"},_={key:2,viewBox:"0 0 24 24",class:"icon icon-small"},x={class:"volume-slider-wrapper"},B=["src"];function X(e,t,i,s,r,o){return(0,l.bo)(((0,l.uX)(),(0,l.CE)("div",u,[(0,l.Lk)("div",{class:"top-progress-bar",onMousedown:t[0]||(t[0]=(...e)=>o.startSeek&&o.startSeek(...e)),onMouseenter:t[1]||(t[1]=e=>r.hovering=!0),onMouseleave:t[2]||(t[2]=e=>r.hovering=!1)},[(0,l.Lk)("div",h,[(0,l.Lk)("div",{class:"progress-bar-fill",style:(0,d.Tr)({width:o.progress+"%"})},null,4),(0,l.Lk)("div",{class:"progress-handle",style:(0,d.Tr)({left:o.progress+"%"})},null,4)])],32),(0,l.Lk)("div",v,[(0,l.Lk)("div",{class:(0,d.C4)(["player-info",{clickable:i.musicId}]),onClick:t[3]||(t[3]=(...e)=>o.navigateToDetail&&o.navigateToDetail(...e))},[i.cover?((0,l.uX)(),(0,l.CE)("img",{key:0,src:i.cover,class:"player-cover"},null,8,y)):(0,l.Q3)("",!0),(0,l.Lk)("div",p,[(0,l.Lk)("div",m,(0,d.v_)(i.title||"未选择歌曲"),1),(0,l.Lk)("div",f,(0,d.v_)(i.artist),1)])],2),(0,l.Lk)("div",g,[(0,l.Lk)("button",{class:"control-btn small-btn",onClick:t[4]||(t[4]=t=>e.$emit("prev")),disabled:!i.src},[...t[17]||(t[17]=[(0,l.Lk)("svg",{viewBox:"0 0 24 24",class:"icon"},[(0,l.Lk)("path",{d:"M6 12l10-7v14L6 12zm-2 7h2V5H4v14z",fill:"currentColor"})],-1)])],8,k),(0,l.Lk)("button",{class:"control-btn play-pause-btn",onClick:t[5]||(t[5]=(...e)=>o.togglePlay&&o.togglePlay(...e)),disabled:!i.src},[r.isPlaying?((0,l.uX)(),(0,l.CE)("svg",I,[...t[19]||(t[19]=[(0,l.Lk)("path",{d:"M6 4h4v16H6V4zm8 0h4v16h-4V4z",fill:"currentColor"},null,-1)])])):((0,l.uX)(),(0,l.CE)("svg",b,[...t[18]||(t[18]=[(0,l.Lk)("path",{d:"M8 5v14l11-7z",fill:"currentColor"},null,-1)])]))],8,L),(0,l.Lk)("button",{class:"control-btn small-btn",onClick:t[6]||(t[6]=t=>e.$emit("next")),disabled:!i.src},[...t[20]||(t[20]=[(0,l.Lk)("svg",{viewBox:"0 0 24 24",class:"icon"},[(0,l.Lk)("path",{d:"M18 12L8 19V5l10 7zm2-7h-2v14h2V5z",fill:"currentColor"})],-1)])],8,S)]),(0,l.Lk)("button",{class:"control-btn mode-btn",onClick:t[7]||(t[7]=t=>e.$emit("togglePlayMode")),title:o.modeLabel},["order"===r.localPlayMode?((0,l.uX)(),(0,l.CE)("svg",w,[...t[21]||(t[21]=[(0,l.Lk)("path",{d:"M3 12l7-7v14l-7-7zm11 0l7-7v14l-7-7z",fill:"currentColor"},null,-1)])])):"random"===r.localPlayMode?((0,l.uX)(),(0,l.CE)("svg",M,[...t[22]||(t[22]=[(0,l.Lk)("path",{d:"M17 1l4 4-4 4V6h-2.59l-4 4H9l4-4H17V1zM3 9l4 4-4 4V9zm8 6l4-4H17v3l4-4-4-4v3h-2.59l-4 4H11z",fill:"currentColor"},null,-1)])])):((0,l.uX)(),(0,l.CE)("svg",P,[...t[23]||(t[23]=[(0,l.Lk)("path",{d:"M7 7v2h6v2H5V7h2zm10 0h2v10h-2v-2h-6v-2h6V7z",fill:"currentColor"},null,-1)])]))],8,C),(0,l.Lk)("div",$,[(0,l.Lk)("button",{class:"control-btn volume-btn",onClick:t[8]||(t[8]=(...e)=>o.toggleMute&&o.toggleMute(...e))},[r.volume>.5?((0,l.uX)(),(0,l.CE)("svg",T,[...t[24]||(t[24]=[(0,l.Lk)("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z",fill:"currentColor"},null,-1)])])):r.volume>0?((0,l.uX)(),(0,l.CE)("svg",E,[...t[25]||(t[25]=[(0,l.Lk)("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z",fill:"currentColor"},null,-1)])])):((0,l.uX)(),(0,l.CE)("svg",_,[...t[26]||(t[26]=[(0,l.Lk)("path",{d:"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z",fill:"currentColor"},null,-1)])]))]),(0,l.Lk)("div",x,[(0,l.bo)((0,l.Lk)("input",{type:"range",class:"volume-slider",min:"0",max:"100","onUpdate:modelValue":t[9]||(t[9]=e=>r.volumePercent=e),onInput:t[10]||(t[10]=(...e)=>o.changeVolume&&o.changeVolume(...e))},null,544),[[a.Jo,r.volumePercent]])])]),(0,l.Lk)("button",{class:"player-close",onClick:t[11]||(t[11]=(...e)=>o.closePlayer&&o.closePlayer(...e))},"✖")]),(0,l.Lk)("audio",{autoplay:"",ref:"audio",src:i.src,onEnded:t[12]||(t[12]=(...e)=>o.onEnded&&o.onEnded(...e)),onPlay:t[13]||(t[13]=(...e)=>o.onPlay&&o.onPlay(...e)),onPause:t[14]||(t[14]=(...e)=>o.onPause&&o.onPause(...e)),onTimeupdate:t[15]||(t[15]=(...e)=>o.updateTime&&o.updateTime(...e)),onLoadedmetadata:t[16]||(t[16]=(...e)=>o.updateDuration&&o.updateDuration(...e))},null,40,B)],512)),[[a.aG,r.visible]])}var O={name:"GlobalAudioPlayer",props:{src:String,title:String,artist:String,cover:String,musicId:[String,Number],playMode:{type:String,default:"order"}},data(){return{visible:!0,isPlaying:!1,currentTime:0,duration:0,volume:1,volumePercent:100,lastVolume:1,isSeeking:!1,wasPlaying:!1,hovering:!1,playedSet:new Set,localPlayMode:this.playMode}},computed:{progress(){return this.duration?this.currentTime/this.duration*100:0},modeLabel(){return{order:"顺序播放",random:"随机播放",single:"单曲循环"}[this.localPlayMode]}},watch:{playMode(e){this.localPlayMode=e},src(e){this.visible=!!e,e&&this.$nextTick(()=>{this.$refs.audio&&this.$refs.audio.play()})}},methods:{startSeek(e){e.preventDefault(),this.duration&&(this.isSeeking=!0,this.wasPlaying=this.isPlaying,this.isPlaying&&this.$refs.audio.pause(),this.tempTime=this.currentTime,this.updateSeekSmooth(e),window.addEventListener("mousemove",this.onGlobalSeekMove),window.addEventListener("mouseup",this.onGlobalSeekEnd))},onGlobalSeekMove(e){this.isSeeking&&(this._rafPending||(this._rafPending=!0,requestAnimationFrame(()=>{this.updateSeekSmooth(e),this._rafPending=!1})))},onGlobalSeekEnd(e){this.isSeeking&&(this.isSeeking=!1,this.updateSeekSmooth(e),this.$refs.audio&&(this.$refs.audio.currentTime=this.tempTime),this.wasPlaying&&this.$refs.audio.play(),window.removeEventListener("mousemove",this.onGlobalSeekMove),window.removeEventListener("mouseup",this.onGlobalSeekEnd))},updateSeekSmooth(e){const t=this.$el.querySelector(".top-progress-bar");if(!t||!this.duration)return;const i=t.getBoundingClientRect(),a=Math.max(0,Math.min(e.clientX-i.left,i.width)),s=a/i.width,l=s*this.duration;this.tempTime=l;const r=this.$el.querySelector(".progress-bar-fill");r&&(r.style.width=100*s+"%");const o=this.$el.querySelector(".progress-handle");o&&(o.style.left=100*s+"%")},togglePlay(){const e=this.$refs.audio;e&&(this.isPlaying?e.pause():e.play())},onEnded(){const e=this.localPlayMode;if(this.isPlaying=!1,"single"===e){const e=this.$refs.audio;e&&(e.currentTime=0,e.play())}else if("order"===e)this.$emit("next");else if("random"===e){if(!this.$parent?.playlist||!Array.isArray(this.$parent.playlist))return void this.$emit("next");const e=this.$parent.playlist;if(0===e.length)return;this.playedSet.add(this.musicId);const t=e.filter(e=>!this.playedSet.has(e.id));let i;t.length>0?i=t[Math.floor(Math.random()*t.length)]:(this.playedSet.clear(),i=e[Math.floor(Math.random()*e.length)]),this.$emit("play-random",i)}},onPlay(){this.isPlaying=!0,this.$emit("play")},onPause(){this.isPlaying=!1,this.$emit("pause")},updateTime(){const e=this.$refs.audio;e&&!this.isSeeking&&(this.currentTime=e.currentTime,this.$emit("timeupdate",this.currentTime))},updateDuration(){const e=this.$refs.audio;e&&(this.duration=e.duration)},changeVolume(){const e=this.$refs.audio;e&&(this.volume=this.volumePercent/100,e.volume=this.volume)},toggleMute(){const e=this.$refs.audio;e&&(this.volume>0?(this.lastVolume=this.volume,this.volume=0,this.volumePercent=0,e.volume=0):(this.volume=this.lastVolume,this.volumePercent=100*this.lastVolume,e.volume=this.lastVolume))},formatTime(e){if(!e||isNaN(e))return"0:00";const t=Math.floor(e/60),i=Math.floor(e%60);return`${t}:${i.toString().padStart(2,"0")}`},navigateToDetail(){this.musicId&&this.$router.push(`/music/${this.musicId}`)},closePlayer(){this.visible=!1;const e=this.$refs.audio;e&&e.pause()}},mounted(){const e=this.$refs.audio;e&&(e.volume=this.volume)}},F=i(6262);const z=(0,F.A)(O,[["render",X],["__scopeId","data-v-295384e4"]]);var U=z,A=i(4335);const D=A.A.create({baseURL:"https://api.vkeys.cn/v2/music/netease",timeout:1e4});function V(e,t=4){return D.get("",{params:{id:e,quality:t}})}function G(e){return D.get("",{params:{word:e}})}function N(e){return D.get("/lyric",{params:{id:e}})}var Q={name:"App",components:{GlobalAudioPlayer:U},data(){return{player:{url:"",song:"",singer:"",cover:"",id:"",playIndex:0,playList:[],currentTime:0},playMode:"order",playedSet:new Set}},methods:{handleTimeUpdate(e){this.player&&(this.player.currentTime=e)},togglePlayMode(){const e=["order","random","single"],t=e[(e.indexOf(this.playMode)+1)%e.length];this.playMode=t,this.playedSet.clear(),console.log("播放模式切换为：",t)},async retryFetchMusicUrl(e,t=10,i=800){for(let s=1;s<=t;s++){try{const t=await V(e);if(200===t.data?.code&&t.data.data.url)return t.data.data.url}catch(a){console.error(`尝试获取音乐 URL 失败（第 ${s} 次）：`,a)}await new Promise(e=>setTimeout(e,i))}return null},async playPrev(){if("random"===this.playMode)return this.playRandom();const e=this.player,t=e.playIndex-1;t>=0?await this.playByIndex(t):console.log("已经是第一首了")},async playNext(){if(console.log("当前模式：",this.playMode),"random"===this.playMode)return this.playRandom();const e=this.player.playIndex+1;e<this.player.playList.length?await this.playByIndex(e):(console.log("播放完最后一首"),this.$root.player=null)},async playRandom(){const{playList:e,playIndex:t}=this.player;if(!e.length)return;this.playedSet.add(e[t]?.id);const i=e.filter(e=>!this.playedSet.has(e.id));0===i.length&&(this.playedSet.clear(),this.playedSet.add(e[t]?.id),console.log("🎲 所有歌曲已播放一轮，重新开始随机"));const a=e.filter(e=>!this.playedSet.has(e.id)),s=a[Math.floor(Math.random()*a.length)],l=e.findIndex(e=>e.id===s.id);await this.playByIndex(l)},async playByIndex(e){const t=this.player,i=t.playList[e],a=await this.retryFetchMusicUrl(i.id);if(!a)return console.warn("无法获取 URL");this.player={...t,url:a,song:i.song,singer:i.singer,cover:i.cover,id:i.id,playIndex:e}}}};const H=(0,F.A)(Q,[["render",c]]);var q=H,J=i(5220);const R={id:"music-search"},j={class:"main-content"},W={class:"search-bar"},K=["placeholder"],Y={key:0},Z={key:1,class:"error"},ee={key:3},te=["src","alt"],ie={class:"detail-info detail-info-fancy"},ae={class:"detail-song detail-song-fancy"},se={class:"detail-meta-row"},le={class:"detail-singer"},re={class:"detail-album"},oe={class:"detail-meta-row"},ne={class:"detail-time"},ce={class:"detail-quality"},de={class:"detail-meta-row"},ue={class:"detail-interval"},he={class:"detail-size"},ve={class:"detail-kbps"},ye={class:"detail-link"},pe=["href"],me={key:0},fe={key:1},ge={key:4};function ke(e,t,i,s,r,o){const n=(0,l.g2)("MusicList");return(0,l.uX)(),(0,l.CE)("div",R,[(0,l.Lk)("div",j,[(0,l.Lk)("div",W,[(0,l.bo)((0,l.Lk)("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>r.searchType=e),class:"search-type-select"},[...t[6]||(t[6]=[(0,l.Lk)("option",{value:"word"},"歌曲名字 >",-1),(0,l.Lk)("option",{value:"id"},"ID/链接",-1)])],512),[[a.u1,r.searchType]]),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>r.searchInput=e),onKeyup:t[2]||(t[2]=(0,a.jR)((...e)=>o.handleSearchUnified&&o.handleSearchUnified(...e),["enter"])),placeholder:"word"===r.searchType?"请输入歌曲名或歌手":"请输入歌曲ID",class:"search-input"},null,40,K),[[a.Jo,r.searchInput]]),(0,l.Lk)("button",{class:"search-btn",onClick:t[3]||(t[3]=(...e)=>o.handleSearchUnified&&o.handleSearchUnified(...e))},"搜索")]),r.loading?((0,l.uX)(),(0,l.CE)("div",Y,"搜索中...")):(0,l.Q3)("",!0),r.error?((0,l.uX)(),(0,l.CE)("div",Z,(0,d.v_)(r.error),1)):(0,l.Q3)("",!0),r.results.length?((0,l.uX)(),(0,l.Wv)(n,{key:2,list:r.results,onGoDetail:o.handleGoDetail,class:"music-list"},null,8,["list","onGoDetail"])):(0,l.Q3)("",!0),r.resultById?((0,l.uX)(),(0,l.CE)("div",ee,[(0,l.Lk)("div",{class:"detail-card detail-card-fancy",onClick:t[5]||(t[5]=e=>o.handleGoDetail(r.resultById.id))},[(0,l.Lk)("img",{src:r.resultById.cover,alt:r.resultById.song,class:"detail-cover detail-cover-fancy"},null,8,te),(0,l.Lk)("div",ie,[(0,l.Lk)("div",ae,(0,d.v_)(r.resultById.song),1),(0,l.Lk)("div",se,[(0,l.Lk)("span",le,"歌手："+(0,d.v_)(r.resultById.singer),1),(0,l.Lk)("span",re,"专辑："+(0,d.v_)(r.resultById.album),1)]),(0,l.Lk)("div",oe,[(0,l.Lk)("span",ne,"发行时间："+(0,d.v_)(r.resultById.time||"未知"),1),(0,l.Lk)("span",ce,"音质："+(0,d.v_)(r.resultById.quality),1)]),(0,l.Lk)("div",de,[(0,l.Lk)("span",ue,"时长："+(0,d.v_)(r.resultById.interval||"未知"),1),(0,l.Lk)("span",he,"大小："+(0,d.v_)(r.resultById.size||"未知"),1),(0,l.Lk)("span",ve,"码率："+(0,d.v_)(r.resultById.kbps||"未知"),1)]),(0,l.Lk)("div",ye,[(0,l.Lk)("a",{href:r.resultById.link,target:"_blank"},"网易云播放页",8,pe)]),(0,l.Lk)("button",{class:(0,d.C4)(["fav-btn fancy-fav-btn",{liked:o.isFavorite(r.resultById.id)}]),onClick:t[4]||(t[4]=(0,a.D$)(e=>o.toggleFavorite(r.resultById.id),["stop"]))},[o.isFavorite(r.resultById.id)?((0,l.uX)(),(0,l.CE)("span",me,"❤️ 已收藏")):((0,l.uX)(),(0,l.CE)("span",fe,"🤍 收藏"))],2)])])])):r.loading||r.error||r.results.length||r.resultById?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",ge,"暂无结果"))])])}const Le={class:"music-list"},be=["src","alt","onClick"],Ie=["onClick"],Se={class:"song"},Ce={class:"singer"},we={class:"album"},Me={class:"time"},Pe={class:"quality"},$e=["onClick"],Te={key:0},Ee={key:1},_e=["onClick"],xe=["src"];function Be(e,t,i,s,r,o){const n=(0,l.g2)("van-icon");return(0,l.uX)(),(0,l.CE)("ul",Le,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(i.list,(e,t)=>((0,l.uX)(),(0,l.CE)("li",{key:e.id,class:"music-item"},[(0,l.Lk)("img",{src:e.cover,alt:e.song,class:"cover",onClick:t=>o.goDetail(e.id),style:{cursor:"pointer"}},null,8,be),(0,l.Lk)("div",{class:"info",onClick:t=>o.goDetail(e.id),style:{cursor:"pointer",flex:"1"}},[(0,l.Lk)("div",Se,(0,d.v_)(e.song),1),(0,l.Lk)("div",Ce,"歌手："+(0,d.v_)(e.singer),1),(0,l.Lk)("div",we,"专辑："+(0,d.v_)(e.album),1),(0,l.Lk)("div",Me,"发行时间："+(0,d.v_)(e.time||"未知"),1),(0,l.Lk)("div",Pe,"音质："+(0,d.v_)(e.quality),1)],8,Ie),(0,l.Lk)("button",{class:(0,d.C4)(["fav-btn",{liked:o.isFavorite(e.id)}]),onClick:(0,a.D$)(t=>o.toggleFavorite(e.id),["stop"])},[o.isFavorite(e.id)?((0,l.uX)(),(0,l.CE)("span",Te,"❤️")):((0,l.uX)(),(0,l.CE)("span",Ee,"🤍"))],10,$e),(0,l.Lk)("button",{class:"play-btn",onClick:i=>o.handlePlay(e,t)},[(0,l.bF)(n,{name:"play-circle"})],8,_e),r.audioMap[e.id]?((0,l.uX)(),(0,l.CE)("audio",{key:0,src:r.audioMap[e.id],controls:"",style:{width:"120px","margin-left":"8px","vertical-align":"middle",display:"none"}},null,8,xe)):(0,l.Q3)("",!0)]))),128))])}i(116);var Xe={name:"MusicList",props:{list:{type:Array,default:()=>[]}},data(){return{favoriteIds:JSON.parse(localStorage.getItem("favoriteMusicIds")||"[]"),audioMap:{}}},methods:{playGlobal(e,t,i){this.$root.player={url:i,song:e.name||e.song,singer:e.singer||e.ar_name,cover:e.cover||e.pic,album:e.album||e.al_name,quality:e.quality,size:e.size,interval:e.interval,kbps:e.kbps,id:e.id,playIndex:t,playList:this.list}},async handlePlay(e,t){console.log("播放了",t);const i=await V(e.id);let a="";i.data&&200===i.data.code&&i.data.data.url?(a=i.data.data.url,this.audioMap[e.id]=i.data.data.url):this.audioMap[e.id]="",this.playGlobal(e,t,a)},goDetail(e){this.$root.player={...this.$root.player,playList:this.list},this.$emit("go-detail",e)},isFavorite(e){return this.favoriteIds.includes(e)},toggleFavorite(e){const t=this.favoriteIds.indexOf(e);if(t>-1){this.favoriteIds.splice(t,1);try{const t=JSON.parse(localStorage.getItem("favoriteMusicCache")||"[]"),i=t.filter(t=>t.id!==e);localStorage.setItem("favoriteMusicCache",JSON.stringify(i))}catch(i){console.warn("更新 favoriteMusicCache 时出错",i)}}else{this.favoriteIds.push(e);try{const t=this.list.find(t=>t.id===e);if(t){const e=JSON.parse(localStorage.getItem("favoriteMusicCache")||"[]");e.unshift({id:t.id,song:t.song||t.name,singer:t.singer||t.ar_name,cover:t.cover||t.pic,album:t.album||t.al_name,quality:t.quality}),localStorage.setItem("favoriteMusicCache",JSON.stringify(e))}}catch(i){console.warn("更新 favoriteMusicCache 时出错",i)}}localStorage.setItem("favoriteMusicIds",JSON.stringify(this.favoriteIds)),window.dispatchEvent(new CustomEvent("favorites-changed",{detail:this.favoriteIds})),this.$emit("favorite-change",this.favoriteIds)}}};const Oe=(0,F.A)(Xe,[["render",Be],["__scopeId","data-v-63a20f06"]]);var Fe=Oe,ze={name:"MusicSearch",components:{MusicList:Fe},data(){return{favoriteIds:JSON.parse(localStorage.getItem("favoriteMusicIds")||"[]"),searchType:"word",searchInput:"",results:[],resultById:null,loading:!1,error:""}},mounted(){const e=localStorage.getItem("musicSearchState");if(e)try{const t=JSON.parse(e);this.searchType=t.searchType||"word",this.searchInput=t.searchInput||"",this.results=t.results||[],this.resultById=t.resultById||null}catch(t){console.error("恢复搜索状态失败：",t)}},methods:{isFavorite(e){return this.favoriteIds.includes(e)},toggleFavorite(e){const t=this.favoriteIds.indexOf(e);t>-1?this.favoriteIds.splice(t,1):this.favoriteIds.push(e),localStorage.setItem("favoriteMusicIds",JSON.stringify(this.favoriteIds))},async handleSearchUnified(){if(!this.searchInput.trim())return this.error="word"===this.searchType?"请输入关键词":"请输入歌曲ID或链接",this.results=[],void(this.resultById=null);this.loading=!0,this.error="",this.results=[],this.resultById=null;try{if("word"===this.searchType){const e=await G(this.searchInput);e.data&&200===e.data.code?this.results=e.data.data||[]:this.error=e.data.message||"搜索失败"}else{let e=this.searchInput.trim();const t=e.match(/id=(\d+)/);t&&(e=t[1]);const i=await V(e);i.data&&200===i.data.code&&i.data.data?this.resultById=i.data.data:this.error=i.data.message||"未找到该ID对应的歌曲"}}catch(e){this.error="请求失败，请稍后重试"}finally{this.loading=!1}localStorage.setItem("musicSearchState",JSON.stringify({searchType:this.searchType,searchInput:this.searchInput,results:this.results,resultById:this.resultById}))},handleGoDetail(e){this.$router.push({path:`/music/${e}`})}}};const Ue=(0,F.A)(ze,[["render",ke],["__scopeId","data-v-79196ecf"]]);var Ae=Ue;const De={key:"music-detail"},Ve={key:0,class:"music-detail-flex"},Ge={class:"music-detail-left"},Ne=["src","alt"],Qe={class:"music-detail-title"},He={class:"music-detail-meta"},qe={class:"music-detail-singer"},Je={class:"music-detail-album"},Re={class:"music-detail-quality"},je={class:"music-detail-size"},We={class:"music-detail-right"},Ke={class:"lyric-scroll"},Ye={key:1,class:"lyric-block"},Ze={class:"lyric"},et={class:"select-audio"},tt={class:"music-detail-select"},it=["value"],at={class:"music-detail-audio"},st={key:0,class:"music-detail-nourl"},lt={key:1},rt={key:2,class:"error"};function ot(e,t,i,s,r,o){return(0,l.uX)(),(0,l.Wv)(a.eB,{name:"fade",mode:"out-in"},{default:(0,l.k6)(()=>[r.music?((0,l.uX)(),(0,l.CE)("div",De,[r.music?((0,l.uX)(),(0,l.CE)("div",Ve,[(0,l.Lk)("div",Ge,[(0,l.Lk)("img",{src:r.music.cover,alt:r.music.song,class:"music-detail-cover"},null,8,Ne),(0,l.Lk)("h2",Qe,(0,d.v_)(r.music.song),1),(0,l.Lk)("div",He,[(0,l.Lk)("div",qe,"歌手："+(0,d.v_)(r.music.singer),1),(0,l.Lk)("div",Je,"专辑："+(0,d.v_)(r.music.album),1),(0,l.Lk)("div",Re,"音质："+(0,d.v_)(r.music.quality),1),(0,l.Lk)("div",je,"大小："+(0,d.v_)(r.music.size||"未知"),1)])]),(0,l.Lk)("div",We,[r.parsedLyric.length?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"lyric-block",ref:"lyricBlock",onMouseenter:t[0]||(t[0]=e=>r.isHoverLyric=!0),onMouseleave:t[1]||(t[1]=e=>r.isHoverLyric=!1)},[t[5]||(t[5]=(0,l.Lk)("h3",null,"歌词",-1)),(0,l.Lk)("div",Ke,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.parsedLyric,(e,t)=>((0,l.uX)(),(0,l.CE)("div",{key:t,class:(0,d.C4)(["lyric-line",{active:t===r.currentLine}]),ref_for:!0,ref:t===r.currentLine?"activeLyric":null},(0,d.v_)(e.text),3))),128))])],544)):r.lyric?((0,l.uX)(),(0,l.CE)("div",Ye,[t[6]||(t[6]=(0,l.Lk)("h3",null,"歌词",-1)),(0,l.Lk)("pre",Ze,(0,d.v_)(r.lyric),1)])):(0,l.Q3)("",!0),(0,l.Lk)("div",et,[(0,l.Lk)("div",tt,[t[7]||(t[7]=(0,l.Lk)("label",{class:"music-detail-label"},"音质：",-1)),(0,l.bo)((0,l.Lk)("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>r.selectedQuality=e),onChange:t[3]||(t[3]=(...e)=>o.fetchAndPlay&&o.fetchAndPlay(...e)),class:"music-detail-selectbox"},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(r.qualityOptions,e=>((0,l.uX)(),(0,l.CE)("option",{key:e.value,value:e.value},(0,d.v_)(e.label),9,it))),128))],544),[[a.u1,r.selectedQuality]])]),(0,l.Lk)("div",at,[(0,l.Lk)("button",{onClick:t[4]||(t[4]=(...e)=>o.playGlobal&&o.playGlobal(...e))},"播放"),r.audioUrl||r.loading?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",st,"请选择音质获取试听链接"))])])])])):r.loading?((0,l.uX)(),(0,l.CE)("div",lt,"加载中...")):r.error?((0,l.uX)(),(0,l.CE)("div",rt,(0,d.v_)(r.error),1)):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)]),_:1})}var nt={name:"MusicDetail",data(){return{music:null,loading:!1,error:"",selectedQuality:4,qualityOptions:[{value:1,label:"标准（64k）"},{value:2,label:"标准（128k）"},{value:3,label:"HQ极高（192k）"},{value:4,label:"HQ极高（320k）"},{value:5,label:"SQ无损"},{value:6,label:"高解析度无损（Hi-Res）"},{value:7,label:"高清臻音（Spatial Autio）"},{value:8,label:"沉浸环绕声（Surround Autio）"},{value:9,label:"超清母带（Master）"}],audioUrl:"",lyric:"",parsedLyric:[],currentLine:0,isHoverLyric:!1,hoverTimeout:null}},async created(){await this.fetchAndPlay(),await this.fetchLyric()},async beforeRouteUpdate(e,t,i){this.music=null,this.audioUrl="",this.lyric="",this.parsedLyric=[],this.currentLine=0,this.error="",this.loading=!0;try{await this.fetchAndPlayById(e.params.id),await this.fetchLyricById(e.params.id),i()}catch(a){this.error="加载新歌曲失败",i(a)}finally{this.loading=!1}},methods:{async fetchAndPlayById(e){const t=await V(e,this.selectedQuality);t.data&&200===t.data.code?(this.music=t.data.data,this.audioUrl=t.data.data.url||""):this.error="未找到播放链接"},async fetchLyricById(e){const t=await N(e);t.data&&200===t.data.code?(this.lyric=t.data.data.lrc||"",this.parsedLyric=this.parseLRC(this.lyric)):this.lyric="暂无歌词"},handleLyric(e){let t=0;for(let i=0;i<this.parsedLyric.length;i++){if(!(e>=this.parsedLyric[i].time))break;t=i}this.currentLine=t,this.scrollLyric()},async fetchAndPlay(){const e=this.$route.params.id;if(!e)return void(this.error="无效的歌曲ID");this.loading=!0,this.audioUrl="";let t=0;const i=10;while(t<i)try{const a=await V(e,this.selectedQuality);if(a.data&&200===a.data.code){this.music=a.data.data,this.audioUrl=a.data.data.url||"",this.error="";break}if(!a.data||503!==a.data.code){this.error=a.data?.message||"未找到该音质的播放链接";break}if(t++,!(t>=i)){console.warn(`503 错误，正在重试 (${t}/${i})...`);continue}this.error="请求失败，已重试 10 次"}catch(a){this.error="请求失败，请稍后重试";break}finally{this.loading=!1}},async fetchLyric(){const e=this.$route.params.id;if(!e)return;let t=0,i=!1;while(t<5&&!i)try{const a=await N(e);if(a.data&&200===a.data.code)this.lyric=a.data.data.lrc||"",this.parsedLyric=this.parseLRC(this.lyric),i=!0;else{if(!a.data||503!==a.data.code){this.lyric="暂无歌词",this.parsedLyric=[];break}t++,await new Promise(e=>setTimeout(e,500))}}catch(a){t++,t>=5&&(this.lyric="歌词获取失败",this.parsedLyric=[])}},parseLRC(e){if(!e)return[];const t=e.split(/\r?\n/),i=[],a=/\[(\d{2}):(\d{2}(?:\.\d{1,3})?)\]/g;for(const s of t){const e=[...s.matchAll(a)],t=s.replace(a,"").trim();for(const a of e){const e=parseInt(a[1]),s=parseFloat(a[2]),l=60*e+s;t&&i.push({time:l,text:t})}}return i.sort((e,t)=>e.time-t.time)},onTimeUpdate(e){const t=e.target,i=t.currentTime;let a=0;for(let s=0;s<this.parsedLyric.length;s++){if(!(i>=this.parsedLyric[s].time))break;a=s}this.currentLine=a,this.scrollLyric()},onLyricMouseEnter(){this.isHoverLyric=!0,this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null)},onLyricMouseLeave(){this.hoverTimeout&&clearTimeout(this.hoverTimeout),this.hoverTimeout=setTimeout(()=>{this.isHoverLyric=!1},3e3)},scrollLyric(){this.isHoverLyric||this.$nextTick(()=>{const e=this.$refs.lyricBlock,t=this.$refs.activeLyric;if(e&&t&&t[0]){const i=e,a=t[0];i.scrollTop=a.offsetTop-i.offsetHeight/2+a.offsetHeight/2}})},playGlobal(){if(this.music){const e=this.$root.player.playList||this.$route.query.playList||[],t=e.findIndex(e=>e.id===this.music.id);this.$root.player={...this.$root.player,...this.music,src:this.audioUrl,playList:e,playIndex:-1!==t?t:0}}}},watch:{selectedQuality(){this.fetchAndPlay(),this.fetchLyric()},"$root.player.currentTime"(e){this.$root.player&&this.$root.player.id===this.music?.id&&this.handleLyric(e)},"$root.player.id"(e){e&&this.$route.params.id!==String(e)&&this.$router.push(`/music/${e}`)}}};const ct=(0,F.A)(nt,[["render",ot],["__scopeId","data-v-0dd46b18"]]);var dt=ct;const ut={class:"favorite-list"},ht={key:0,class:"empty"};function vt(e,t,i,s,r,o){const n=(0,l.g2)("FavoriteMusicList");return(0,l.uX)(),(0,l.CE)("div",ut,[t[0]||(t[0]=(0,l.Lk)("h2",null,"我喜欢的音乐",-1)),(0,l.bF)(a.F,{name:"stagger",tag:"div"},{default:(0,l.k6)(()=>[r.favoriteSongs.length?((0,l.uX)(),(0,l.Wv)(n,{key:"fav-list",list:r.favoriteSongs,onRefresh:o.fetchFavorites},null,8,["list","onRefresh"])):(0,l.Q3)("",!0)]),_:1}),r.favoriteSongs.length?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",ht,"暂无喜欢的音乐"))])}i(7588),i(1701);const yt={class:"fav-music-list"},pt=["onClick"],mt=["src","alt"],ft={class:"fav-info"},gt={class:"fav-song"},kt={class:"fav-singer"},Lt={class:"fav-album"},bt={class:"fav-quality"},It={class:"fav-audio-row"},St=["onClick"],Ct=["onClick"];function wt(e,t,i,s,r,o){const n=(0,l.g2)("van-icon");return(0,l.uX)(),(0,l.CE)("ul",yt,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(i.list,(e,i)=>((0,l.uX)(),(0,l.CE)("li",{key:e.url||e.id,style:(0,d.Tr)({"--i":i}),class:"fav-music-item",onClick:t=>o.handleGoDetail(e.id)},[(0,l.Lk)("img",{src:e.pic||e.cover,alt:e.name||e.song,class:"fav-cover"},null,8,mt),(0,l.Lk)("div",ft,[(0,l.Lk)("div",gt,(0,d.v_)(e.name||e.song),1),(0,l.Lk)("div",kt,"歌手："+(0,d.v_)(e.ar_name||e.singer),1),(0,l.Lk)("div",Lt,"专辑："+(0,d.v_)(e.al_name||e.album),1),(0,l.Lk)("div",bt,"音质："+(0,d.v_)(e.quality),1),(0,l.Lk)("div",It,[(0,l.Lk)("button",{class:"play-btn",onClick:(0,a.D$)(t=>o.playGlobal(e,i),["stop"])},[(0,l.bF)(n,{name:"play-circle-o"}),t[0]||(t[0]=(0,l.eW)(" 播放 ",-1))],8,St),(0,l.Lk)("button",{class:"unfav-btn",onClick:(0,a.D$)(t=>o.removeFavorite(e.id),["stop"])},"❤️",8,Ct)])])],12,pt))),128))])}var Mt={name:"FavoriteMusicList",props:{list:{type:Array,default:()=>[]}},methods:{playGlobal(e,t){this.$root.player={url:e.url,song:e.name||e.song,singer:e.singer||e.ar_name,cover:e.cover||e.pic,album:e.album||e.al_name,id:e.id,playIndex:t,playList:this.list}},removeFavorite(e){let t=JSON.parse(localStorage.getItem("favoriteMusicIds")||"[]");t=t.filter(t=>t!==e),localStorage.setItem("favoriteMusicIds",JSON.stringify(t));const i=JSON.parse(localStorage.getItem("favoriteMusicCache")||"[]"),a=i.filter(t=>t.id!==e);localStorage.setItem("favoriteMusicCache",JSON.stringify(a)),this.$emit("refresh")},handleGoDetail(e){this.$router.push({path:`/music/${e}`})}}};const Pt=(0,F.A)(Mt,[["render",wt],["__scopeId","data-v-48754a84"]]);var $t=Pt,Tt={name:"FavoriteList",components:{FavoriteMusicList:$t},data(){return{favoriteSongs:[]}},async created(){await this.fetchFavorites()},mounted(){window.addEventListener("favorites-changed",this.fetchFavorites)},beforeUnmount(){window.removeEventListener("favorites-changed",this.fetchFavorites)},methods:{async fetchFavorites(){const e=JSON.parse(localStorage.getItem("favoriteMusicIds")||"[]");if(!e.length)return void(this.favoriteSongs=[]);const t=JSON.parse(localStorage.getItem("favoriteMusicCache")||"[]"),i=new Map(t.map(e=>[e.id,e])),a=e.slice(0,50),s=a.map(e=>{const t=i.get(e);if(t){const{url:e,...i}=t;return console.log(e),i}return null}).filter(Boolean);this.favoriteSongs=[];let l=0;const r=setInterval(()=>{l<s.length?(this.favoriteSongs.push(s[l]),l++):clearInterval(r)},100),o=await Promise.all(s.map(e=>this.fetchUrlOnly(e.id)));s.forEach((e,t)=>{e.url=o[t]?.url||""});const n=e.slice(50);if(n.length){const e=await Promise.all(n.map(e=>this.fetchWithRetry(e)));this.favoriteSongs=[...this.favoriteSongs,...e.flat()]}},async fetchUrlOnly(e){try{const t=await V(e);if(t.data&&200===t.data.code){const e=t.data.data?.[0]||t.data.data;return{url:e.url}}}catch(t){console.warn("获取url失败:",e,t)}return{}},async fetchWithRetry(e,t=8){let i=0;while(i<t){const t=await V(e);if(t.data&&200===t.data.code)return t.data.data;if(!t.data||503!==t.data.code)break;i++,await new Promise(e=>setTimeout(e,200))}return[]}}};const Et=(0,F.A)(Tt,[["render",vt],["__scopeId","data-v-74a77f58"]]);var _t=Et;const xt=[{path:"/",component:Ae},{path:"/music/:id",component:dt,props:!0},{path:"/favorite",component:_t}],Bt=(0,J.aE)({history:(0,J.Bt)(),routes:xt});var Xt=Bt,Ot=i(7693);i(2241);const Ft=(0,a.Ef)(q);Ft.config.globalProperties.player=(0,s.Kh)({id:null,src:"",playList:[],currentTime:0}),Ft.use(Xt),Ft.use(Ot.I),Ft.mount("#app")}},t={};function i(a){var s=t[a];if(void 0!==s)return s.exports;var l=t[a]={exports:{}};return e[a].call(l.exports,l,l.exports,i),l.exports}i.m=e,function(){var e=[];i.O=function(t,a,s,l){if(!a){var r=1/0;for(d=0;d<e.length;d++){a=e[d][0],s=e[d][1],l=e[d][2];for(var o=!0,n=0;n<a.length;n++)(!1&l||r>=l)&&Object.keys(i.O).every(function(e){return i.O[e](a[n])})?a.splice(n--,1):(o=!1,l<r&&(r=l));if(o){e.splice(d--,1);var c=s();void 0!==c&&(t=c)}}return t}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[a,s,l]}}(),function(){i.d=function(e,t){for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}}(),function(){i.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){var e={524:0};i.O.j=function(t){return 0===e[t]};var t=function(t,a){var s,l,r=a[0],o=a[1],n=a[2],c=0;if(r.some(function(t){return 0!==e[t]})){for(s in o)i.o(o,s)&&(i.m[s]=o[s]);if(n)var d=n(i)}for(t&&t(a);c<r.length;c++)l=r[c],i.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return i.O(d)},a=self["webpackChunkmusic_web"]=self["webpackChunkmusic_web"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))}();var a=i.O(void 0,[504],function(){return i(151)});a=i.O(a)})();
//# sourceMappingURL=app.63d771a1.js.map